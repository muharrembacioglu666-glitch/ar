<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Projesi - Sticky Test v1.5.1</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; }
        
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none; font-family: sans-serif;
        }
        #ui-layer * { pointer-events: auto; }

        .version-control {
            position: absolute; right: 15px; top: 20px;
            display: flex; flex-direction: column; align-items: flex-end; gap: 10px;
        }

        .ver-badge {
            background: rgba(0,0,0,0.8); color: #ff0055;
            padding: 5px 15px; border-radius: 20px; border: 1px solid #ff0055;
            font-size: 0.8rem;
        }

        #status-msg {
            position: absolute; bottom: 30px; width: 100%; text-align: center;
            color: white; font-weight: bold; text-shadow: 0 2px 4px black;
            font-size: 1.2rem;
        }
    </style>

    <script>
        // YAPIŞKAN NESNE MANTIĞI (Markerless Fallback)
        AFRAME.registerComponent('sticky-object', {
            init: function () {
                const marker = this.el;
                const objectGroup = document.getElementById('ar-object');
                const scene = document.querySelector('a-scene');
                let isLocked = false;

                // Marker bulunduğunda çalışır
                marker.addEventListener('markerFound', () => {
                    if (isLocked) return; // Zaten kilitlendiyse tekrar çalışma

                    // 1. O anki dünya pozisyonunu kopyala
                    let worldPos = new THREE.Vector3();
                    let worldQuat = new THREE.Quaternion();
                    let worldScale = new THREE.Vector3();

                    objectGroup.object3D.getWorldPosition(worldPos);
                    objectGroup.object3D.getWorldQuaternion(worldQuat);
                    objectGroup.object3D.getWorldScale(worldScale);

                    // 2. Nesneyi Marker'dan kopar, Sahneye (Scene) yapıştır
                    // Bu sayede marker gitse bile nesne sahnede kalır
                    objectGroup.parentNode.removeChild(objectGroup);
                    scene.appendChild(objectGroup);

                    // 3. Kopyaladığımız pozisyonu geri yükle
                    objectGroup.object3D.position.copy(worldPos);
                    objectGroup.object3D.quaternion.copy(worldQuat);
                    objectGroup.object3D.scale.copy(worldScale);
                    
                    // Görünür olduğundan emin ol
                    objectGroup.setAttribute('visible', 'true');

                    isLocked = true;
                    
                    // Kullanıcıya bilgi ver
                    document.getElementById('status-msg').innerText = "NESNE SABİTLENDİ! Kamerayı çevirebilirsin.";
                    document.getElementById('info-text').setAttribute('value', 'FIXED MODE');
                    document.getElementById('info-text').setAttribute('color', '#ff0055');
                });
            }
        });
    </script>
</head>

<body>

    <div id="ui-layer">
        <div class="version-control">
            <div class="ver-badge">v1.5.1 (HIRO TEST)</div>
        </div>
        <div id="status-msg">Hiro Marker aranıyor...</div>
    </div>

    <!-- AR SAHNESİ -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false;"
        vr-mode-ui="enabled: false">
        
        <!-- TEST İÇİN HIRO MARKER KULLANIYORUZ -->
        <!-- sticky-object kodunu buraya ekledik -->
        <a-marker preset="hiro" sticky-object>
            
            <!-- Bu grup marker görülünce sahneye transfer edilecek -->
            <a-entity id="ar-object">
                <a-box 
                    position="0 0.5 0" 
                    scale="0.5 0.5 0.5"
                    material="color: #ff0055; opacity: 0.9;"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
                </a-box>
                <a-text id="info-text" value="TARANIYOR..." position="0 1 0" align="center" color="white" scale="0.5 0.5 0.5"></a-text>
            </a-entity>

        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

</body>
</html>
