<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Oyun Portalı v1.9.6</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');

        :root {
            --primary-yellow: #ffcc00;
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --accent-blue: #2196F3;
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* HEADER */
        header {
            width: 100%;
            padding: 20px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            background: #1a1a1a;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-yellow);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #aaa;
        }

        .nav-links span { cursor: pointer; transition: color 0.3s; }
        .nav-links span:hover { color: #fff; }
        .nav-links span.active {
            color: var(--primary-yellow);
            font-weight: 600;
        }

        /* DÖNEN RENKLİ SÜRÜM ROZETİ */
        .version-wrapper {
            position: relative;
            padding: 2px;
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .version-wrapper:hover { transform: scale(1.05); }
        .version-wrapper::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(#ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff, #ff0000);
            animation: rotateBorder 2s linear infinite;
            z-index: 0;
        }
        @keyframes rotateBorder { 100% { transform: rotate(360deg); } }
        .version-badge {
            position: relative;
            background: #000;
            padding: 5px 15px;
            border-radius: 18px;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ANA SAYFA (HOME SCREEN) */
        #home-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 100px 20px;
            animation: fadeIn 0.8s ease-out;
        }
        .hero-title { font-size: 64px; font-weight: 800; margin: 0; background: linear-gradient(45deg, #fff, var(--primary-yellow)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-subtitle { font-size: 20px; color: #888; margin-bottom: 40px; max-width: 600px; }
        .cta-button {
            background: var(--primary-yellow);
            color: #000;
            padding: 15px 40px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 18px;
            text-decoration: none;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 204, 0, 0.2);
        }
        .cta-button:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(255, 204, 0, 0.4); }

        /* OYUN MENÜSÜ */
        #menu-screen {
            display: none;
            text-align: center;
            margin-top: 50px;
            animation: fadeIn 0.5s;
        }
        h2.section-title { font-size: 28px; margin-bottom: 30px; }
        .games-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            padding-bottom: 50px;
        }
        .game-card {
            background: var(--card-bg);
            border: 1px solid #333;
            border-radius: 15px;
            width: 280px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .game-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-yellow);
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.2);
        }
        .game-icon svg { width: 60px; height: 60px; fill: none; stroke: var(--primary-yellow); stroke-width: 3; }
        .game-icon.fill svg { fill: var(--primary-yellow); stroke: none; }
        .game-title { font-weight: 700; font-size: 20px; }
        .game-desc { font-size: 13px; color: #888; }

        /* OYUN ALANI */
        #game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            width: 100%;
        }
        .game-header { display: flex; justify-content: space-between; width: 600px; margin-bottom: 10px; align-items: center; }
        .back-btn { background: #333; border: none; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        canvas { background: #000; border: 2px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* MODAL */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-content { background: #1a1a1a; width: 500px; max-height: 80vh; border-radius: 15px; border: 1px solid #444; padding: 30px; overflow-y: auto; }
        .changelog-item { margin-bottom: 20px; }
        .version-title { color: var(--primary-yellow); font-weight: bold; }
        .change-list { list-style: none; padding: 0; font-size: 13px; color: #ccc; }
        .change-list li { margin-bottom: 5px; padding-left: 15px; position: relative; }
        .change-list li::before { content: '•'; color: #555; position: absolute; left: 0; }
        .close-modal { background: none; border: none; color: #888; font-size: 24px; cursor: pointer; float: right; }

        /* ANIMASYONLAR */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #game-over-screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95); padding: 40px; border-radius: 15px; text-align: center; display: none;
            border: 2px solid var(--primary-yellow); z-index: 50;
        }
        .restart-btn { background: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="showHomeScreen()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffcc00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"></rect><path d="M6 12h4m-2-2v4"></path><line x1="15" y1="11" x2="15" y2="11"></line><line x1="18" y1="13" x2="18" y2="13"></line></svg>
            OYUN PORTALI
        </div>
        <div class="nav-links">
            <span id="nav-home" class="active" onclick="showHomeScreen()">Anasayfa</span>
            <span id="nav-games" onclick="showGamesMenu()">Oyunlar</span>
            <span>Ders Notları</span>
            <span>Filmler</span>
        </div>
        <div class="version-wrapper" onclick="openChangelog()">
            <div class="version-badge">v1.9.6 <span>ℹ</span></div>
        </div>
    </header>

    <div id="home-screen">
        <h1 class="hero-title">Eğlence Başlıyor</h1>
        <p class="hero-subtitle">Retro oyunlardan modern klasiklere kadar her şey burada. Vaktini değerlendirmenin en keyifli yolu!</p>
        <button class="cta-button" onclick="showGamesMenu()">HEMEN OYNA</button>
    </div>

    <div id="menu-screen">
        <h2 class="section-title">Oyun Kütüphanesi</h2>
        <div class="games-grid">
            <div class="game-card" onclick="startGame('snake')">
                <div class="game-icon">
                    <svg viewBox="0 0 24 24"><path d="M7 4v2a2 2 0 0 1-2 2H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2a2 2 0 0 1 2 2v2" stroke="#ffcc00"></path><circle cx="8" cy="4" r="2" fill="#ffcc00" stroke="none"></circle></svg>
                </div>
                <div class="game-title">Yılan Oyunu</div>
                <div class="game-desc">Yılanı büyüt, engellere çarpma!</div>
            </div>

            <div class="game-card" onclick="startGame('tetris')">
                <div class="game-icon fill">
                    <svg viewBox="0 0 24 24"><rect x="2" y="2" width="9" height="9" rx="1"></rect><rect x="13" y="2" width="9" height="9" rx="1"></rect><rect x="2" y="13" width="9" height="9" rx="1"></rect><rect x="13" y="13" width="9" height="9" rx="1"></rect></svg>
                </div>
                <div class="game-title">Tetris</div>
                <div class="game-desc">Blokları yerleştir, satırları yok et.</div>
            </div>

            <div class="game-card" onclick="startGame('pacman')">
                <div class="game-icon fill">
                    <svg viewBox="0 0 24 24"><path d="M12 2a8 8 0 0 0-8 8v10a2 2 0 0 0 2 2c.5 0 1-.5 1.5-1s1 1 1.5 1 1.5-1 1.5-1 1.5-1 1.5-1 2-2V10a8 8 0 0 0-8-8z"></path><circle cx="9" cy="9" r="1.5" fill="#000"></circle><circle cx="15" cy="9" r="1.5" fill="#000"></circle></svg>
                </div>
                <div class="game-title">Pac-Man</div>
                <div class="game-desc">Hayaletten kaç, yemleri topla.</div>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div class="game-header">
            <button class="back-btn" onclick="showGamesMenu()">← Menüye Dön</button>
            <div id="score-display" style="font-weight:bold; color:#ffcc00; font-size:18px;">SKOR: 0</div>
        </div>
        <div style="position: relative;">
            <canvas id="gameCanvas" width="600" height="600"></canvas>
            <div id="game-over-screen">
                <div id="game-end-title" style="color: #ff4444; font-size: 32px; font-weight: bold; margin-bottom: 10px;">OYUN BİTTİ</div>
                <div id="final-score" style="font-size: 24px; color: #fff;">Skor: 0</div>
                <button class="restart-btn" onclick="restartGame()">Tekrar Oyna</button>
            </div>
        </div>
    </div>

    <div id="changelog-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="closeChangelog()">×</button>
            <h3 style="margin-top:0">Sürüm Geçmişi</h3>
            <div class="changelog-item">
                <div class="version-title">v1.9.6</div>
                <ul class="change-list">
                    <li>Harita Genişletildi: Pac-Man haritasının boyu 2 katına çıkarıldı.</li>
                    <li>Dengeleme: Hayaletlerin hızı biraz düşürüldü (Pac-Man'den %25 daha yavaşlar).</li>
                </ul>
            </div>
             <div class="changelog-item">
                <div class="version-title">v1.9.5</div>
                <ul class="change-list">
                    <li>Pac-Man Dengesi: Power Pellet süresi 4 saniyeye düşürüldü.</li>
                </ul>
            </div>
             <div class="changelog-item">
                <div class="version-title">v1.9.4</div>
                <ul class="change-list">
                    <li>Pac-Man Yapay Zekası: 4 Hayalet (Kırmızı, Mavi, Pembe, Sarı) eklendi.</li>
                    <li>Power Pellet: Haritaya 8 özel yem eklendi.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // EKRAN YÖNETİMİ
        const homeScreen = document.getElementById('home-screen');
        const menuScreen = document.getElementById('menu-screen');
        const gameContainer = document.getElementById('game-container');
        const navHome = document.getElementById('nav-home');
        const navGames = document.getElementById('nav-games');

        function showHomeScreen() {
            stopAnyGame();
            homeScreen.style.display = 'flex';
            menuScreen.style.display = 'none';
            gameContainer.style.display = 'none';
            navHome.classList.add('active');
            navGames.classList.remove('active');
        }

        function showGamesMenu() {
            stopAnyGame();
            homeScreen.style.display = 'none';
            menuScreen.style.display = 'block';
            gameContainer.style.display = 'none';
            navHome.classList.remove('active');
            navGames.classList.add('active');
        }

        function stopAnyGame() {
            if(gameInterval) clearInterval(gameInterval);
            document.onkeydown = null;
        }

        // MODAL
        function openChangelog() { document.getElementById('changelog-modal').style.display = 'flex'; }
        function closeChangelog() { document.getElementById('changelog-modal').style.display = 'none'; }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreText = document.getElementById('final-score');
        const gameEndTitle = document.getElementById('game-end-title');

        let activeGame = null;
        let gameInterval = null;
        let score = 0;
        let isGameOver = false;

        function startGame(type) {
            menuScreen.style.display = 'none';
            gameContainer.style.display = 'flex';
            activeGame = type;
            isGameOver = false;
            gameOverScreen.style.display = 'none';
            score = 0;
            updateScore(0);
            if(gameInterval) clearInterval(gameInterval);
            
            document.onkeydown = handleInput;

            if(type === 'snake') initSnake();
            if(type === 'tetris') initTetris();
            if(type === 'pacman') initPacman();
        }

        function showGameOver(text, titleColor) {
            clearInterval(gameInterval);
            isGameOver = true;
            finalScoreText.innerText = text || `Skor: ${score}`;
            if(titleColor) gameEndTitle.style.color = titleColor;
            else gameEndTitle.style.color = "#ff4444";
            if(text && text.includes("KAZANDIN")) gameEndTitle.innerText = "TEBRİKLER!";
            else gameEndTitle.innerText = "OYUN BİTTİ";
            gameOverScreen.style.display = 'block';
        }

        function restartGame() { startGame(activeGame); }

        function updateScore(val) {
            score = val;
            if(activeGame === 'pacman') scoreDisplay.innerText = `SKOR: ${score} | CAN: ${pacmanLives} | SÜRE: ${powerModeTime > 0 ? (powerModeTime/1000).toFixed(1) : 0}`;
            else scoreDisplay.innerText = `SKOR: ${score}`;
        }

        function handleInput(e) {
            if(isGameOver) return;
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)) e.preventDefault();
            if(activeGame === 'snake') handleSnakeInput(e);
            if(activeGame === 'tetris') handleTetrisInput(e);
            if(activeGame === 'pacman') handlePacmanInput(e);
        }

        // ======================== YILAN (SNAKE) ========================
        let snake=[], apple={}, snakeDir={}, nextSnakeDir={};
        const sGrid=25, sCols=24, sRows=24;

        function initSnake() {
            canvas.width = 600; canvas.height = 600;
            snake = [{x:10,y:10}, {x:9,y:10}, {x:8,y:10}];
            snakeDir = {x:1, y:0}; nextSnakeDir = {x:1, y:0};
            apple = spawnApple();
            gameInterval = setInterval(updateSnake, 100);
        }
        function spawnApple() { return {x: Math.floor(Math.random()*sCols), y: Math.floor(Math.random()*sRows)}; }
        function handleSnakeInput(e) {
            if(e.key==='ArrowUp' && snakeDir.y===0) nextSnakeDir={x:0, y:-1};
            if(e.key==='ArrowDown' && snakeDir.y===0) nextSnakeDir={x:0, y:1};
            if(e.key==='ArrowLeft' && snakeDir.x===0) nextSnakeDir={x:-1, y:0};
            if(e.key==='ArrowRight' && snakeDir.x===0) nextSnakeDir={x:1, y:0};
        }
        function updateSnake() {
            snakeDir = nextSnakeDir;
            let head = {x: snake[0].x + snakeDir.x, y: snake[0].y + snakeDir.y};
            if(head.x<0 || head.x>=sCols || head.y<0 || head.y>=sRows) return showGameOver();
            if(snake.some(p => p.x===head.x && p.y===head.y)) return showGameOver();
            snake.unshift(head);
            if(head.x===apple.x && head.y===apple.y) { score++; updateScore(score); apple = spawnApple(); } else snake.pop();
            for(let r=0; r<sRows; r++) for(let c=0; c<sCols; c++) {
                ctx.fillStyle = (r+c)%2===0 ? "#aad751" : "#a2d149";
                ctx.fillRect(c*sGrid, r*sGrid, sGrid, sGrid);
            }
            ctx.fillStyle="#e7471d"; ctx.beginPath(); ctx.arc(apple.x*sGrid+sGrid/2, apple.y*sGrid+sGrid/2, sGrid/2-2, 0, Math.PI*2); ctx.fill();
            snake.forEach((p, i) => {
                ctx.fillStyle = (i === 0) ? "#4674E9" : "#315ecb";
                ctx.fillRect(p.x*sGrid+1, p.y*sGrid+1, sGrid-2, sGrid-2);
                if(i === 0) {
                    ctx.fillStyle = "white"; const eyeSize = 3; let eyeX1, eyeY1, eyeX2, eyeY2;
                    if(snakeDir.x === 1) { eyeX1 = eyeX2 = p.x*sGrid + 18; eyeY1 = p.y*sGrid + 6; eyeY2 = p.y*sGrid + 18; }
                    else if(snakeDir.x === -1) { eyeX1 = eyeX2 = p.x*sGrid + 6; eyeY1 = p.y*sGrid + 6; eyeY2 = p.y*sGrid + 18; }
                    else if(snakeDir.y === -1) { eyeY1 = eyeY2 = p.y*sGrid + 6; eyeX1 = p.x*sGrid + 6; eyeX2 = p.x*sGrid + 18; }
                    else { eyeY1 = eyeY2 = p.y*sGrid + 18; eyeX1 = p.x*sGrid + 6; eyeX2 = p.x*sGrid + 18; }
                    ctx.beginPath(); ctx.arc(eyeX1, eyeY1, eyeSize, 0, Math.PI*2); ctx.arc(eyeX2, eyeY2, eyeSize, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(eyeX1, eyeY1, 1.5, 0, Math.PI*2); ctx.arc(eyeX2, eyeY2, 1.5, 0, Math.PI*2); ctx.fill();
                }
            });
        }

        // ======================== TETRIS ========================
        const tRows=20, tCols=10, tSize=30;
        let board=[], currentPiece=null;
        const TETROMINOS = [
            { matrix: [[1,1,1,1]], color: "cyan" },
            { matrix: [[1,1],[1,1]], color: "yellow" },
            { matrix: [[0,1,0],[1,1,1]], color: "purple" },
            { matrix: [[0,1,1],[1,1,0]], color: "green" },
            { matrix: [[1,1,0],[0,1,1]], color: "red" },
            { matrix: [[1,0,0],[1,1,1]], color: "blue" },
            { matrix: [[0,0,1],[1,1,1]], color: "orange" }
        ];
        function initTetris() {
            canvas.width = 300; canvas.height = 600;
            board = Array.from({length: tRows}, () => Array(tCols).fill(null));
            spawnTetrisPiece();
            gameInterval = setInterval(updateTetris, 1000);
            drawTetris();
        }
        function spawnTetrisPiece() {
            const r = Math.floor(Math.random() * TETROMINOS.length);
            currentPiece = { matrix: JSON.parse(JSON.stringify(TETROMINOS[r].matrix)), color: TETROMINOS[r].color, x: 3, y: 0 };
            if (checkCollision(0, 0, currentPiece.matrix)) showGameOver();
        }
        function updateTetris() { moveTetrisDown(); drawTetris(); }
        function moveTetrisDown() {
            if(!currentPiece) return;
            if(!checkCollision(0, 1, currentPiece.matrix)) currentPiece.y++; 
            else { lockTetrisPiece(); spawnTetrisPiece(); }
        }
        function handleTetrisInput(e) {
            if(!currentPiece || isGameOver) return;
            if(e.key === 'ArrowLeft') { if(!checkCollision(-1, 0, currentPiece.matrix)) currentPiece.x--; } 
            else if(e.key === 'ArrowRight') { if(!checkCollision(1, 0, currentPiece.matrix)) currentPiece.x++; } 
            else if(e.key === 'ArrowDown') moveTetrisDown(); 
            else if(e.key === 'ArrowUp') {
                const rotated = currentPiece.matrix[0].map((_, i) => currentPiece.matrix.map(row => row[i]).reverse());
                if(!checkCollision(0, 0, rotated)) currentPiece.matrix = rotated;
            }
            drawTetris();
        }
        function checkCollision(offX, offY, matrix) {
            for(let r=0; r<matrix.length; r++) for(let c=0; c<matrix[r].length; c++) if(matrix[r][c]){
                let nx = currentPiece.x + c + offX, ny = currentPiece.y + r + offY;
                if(nx<0 || nx>=tCols || ny>=tRows || (ny>=0 && board[ny][nx])) return true;
            }
            return false;
        }
        function lockTetrisPiece() {
            currentPiece.matrix.forEach((row, r) => row.forEach((val, c) => {
                if(val && currentPiece.y + r >= 0) board[currentPiece.y+r][currentPiece.x+c] = currentPiece.color;
            }));
            for(let r=0; r<tRows; r++) if(board[r].every(cell => cell !== null)) {
                board.splice(r, 1); board.unshift(Array(tCols).fill(null)); score += 100; updateScore(score);
            }
        }
        function drawTetris() {
            ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width, canvas.height);
            for(let r=0; r<tRows; r++) for(let c=0; c<tCols; c++) if(board[r][c]) drawBlock(c, r, board[r][c]);
            if(currentPiece) currentPiece.matrix.forEach((row, r) => row.forEach((val, c) => { if(val) drawBlock(currentPiece.x+c, currentPiece.y+r, currentPiece.color); }));
        }
        function drawBlock(x, y, color) { ctx.fillStyle = color; ctx.fillRect(x*tSize, y*tSize, tSize, tSize); ctx.strokeStyle = "#000"; ctx.strokeRect(x*tSize, y*tSize, tSize, tSize); }

        // ======================== PACMAN (GELİŞMİŞ SÜRÜM - V1.9.6) ========================
        const pGrid = 20, pCols = 19;
        // 0: Dot, 1: Wall, 2: Empty, 3: POWER PELLET (8 Tane)
        // Harita Uzatıldı (2 Katı)
        const pMapLayout = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,3,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,3,1],
            [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
            [1,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],
            [2,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,2],[1,1,1,1,0,1,2,1,1,2,1,1,2,1,0,1,1,1,1],
            [1,0,0,0,0,0,0,1,2,2,2,1,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
            [1,3,0,1,0,0,0,0,0,3,0,0,0,0,0,1,0,3,1],[1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
            // TEKRAR EDEN ORTA BÖLÜM (Haritayı Uzatmak İçin)
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
            [1,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],
            [2,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,2],[1,1,1,1,0,1,2,1,1,2,1,1,2,1,0,1,1,1,1],
            [1,0,0,0,0,0,0,1,2,2,2,1,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
            [1,3,0,1,0,0,0,0,0,3,0,0,0,0,0,1,0,3,1],[1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],
            [1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        
        let pacman={}, ghosts=[], pacmanLives=3, pacMap=[], powerModeTime=0, totalPellets=0, gameTick=0;

        function initPacman() {
            canvas.width = pCols * 30; canvas.height = pMapLayout.length * 30;
            pacMap = JSON.parse(JSON.stringify(pMapLayout));
            pacmanLives=3; 
            powerModeTime=0;
            totalPellets = 0;
            gameTick = 0;
            
            // Yemleri say
            for(let r=0; r<pacMap.length; r++) 
                for(let c=0; c<pacMap[r].length; c++) 
                    if(pacMap[r][c]===0 || pacMap[r][c]===3) totalPellets++;

            resetPacPositions(); 
            updateScore(0);
            // Hızı biraz yavaşlatıyoruz (150ms -> 180ms)
            gameInterval = setInterval(updatePacman, 180);
        }

        function resetPacPositions() {
            // Başlangıç noktalarını harita ortasına göre ayarla (Harita uzadığı için)
            let startY = Math.floor(pacMap.length / 2);
            pacman = {x: 9, y: startY + 4, dirX:0, dirY:0, nextDirX:0, nextDirY:0};
            // 4 HAYALET
            ghosts = [
                {x: 9, y: 8, color: 'red', type: 'red', startX:9, startY:8},       
                {x: 8, y: 8, color: '#FFB8FF', type: 'pink', startX:8, startY:8},   
                {x: 10, y: 8, color: '#00FFFF', type: 'blue', startX:10, startY:8}, 
                {x: 9, y: 7, color: '#FFCC00', type: 'yellow', startX:9, startY:7}  
            ];
        }

        function handlePacmanInput(e) {
            if(e.key==='ArrowUp') { pacman.nextDirX=0; pacman.nextDirY=-1; }
            if(e.key==='ArrowDown') { pacman.nextDirX=0; pacman.nextDirY=1; }
            if(e.key==='ArrowLeft') { pacman.nextDirX=-1; pacman.nextDirY=0; }
            if(e.key==='ArrowRight') { pacman.nextDirX=1; pacman.nextDirY=0; }
        }

        function hasLineOfSight(g, p) {
            if(g.x !== p.x && g.y !== p.y) return false;
            if(g.y === p.y) {
                let min = Math.min(g.x, p.x), max = Math.max(g.x, p.x);
                for(let i=min+1; i<max; i++) if(pacMap[g.y][i] === 1) return false;
            } else {
                let min = Math.min(g.y, p.y), max = Math.max(g.y, p.y);
                for(let i=min+1; i<max; i++) if(pacMap[i][g.x] === 1) return false;
            }
            return true;
        }

        function getBestMove(g, targetX, targetY) {
            let moves = [{x:0, y:-1}, {x:0, y:1}, {x:-1, y:0}, {x:1, y:0}];
            moves = moves.filter(m => pacMap[g.y+m.y] && pacMap[g.y+m.y][g.x+m.x] !== 1);
            if(moves.length === 0) return {x:0, y:0};

            if((powerModeTime > 0) || (g.type === 'pink' && Math.random() < 0.3)) {
                return moves[Math.floor(Math.random() * moves.length)];
            }

            return moves.sort((a,b) => {
                let distA = Math.abs((g.x+a.x) - targetX) + Math.abs((g.y+a.y) - targetY);
                let distB = Math.abs((g.x+b.x) - targetX) + Math.abs((g.y+b.y) - targetY);
                if(powerModeTime > 0) return distB - distA; 
                return distA - distB;
            })[0];
        }

        function updatePacman() {
            gameTick++;

            // SÜRE YÖNETİMİ
            if(powerModeTime > 0) {
                powerModeTime -= 180; 
                updateScore(score); 
            }

            // PACMAN HAREKET (Her tick'te hareket eder)
            if(pacMap[pacman.y + pacman.nextDirY] && pacMap[pacman.y + pacman.nextDirY][pacman.x + pacman.nextDirX] !== 1) { 
                pacman.dirX = pacman.nextDirX; pacman.dirY = pacman.nextDirY; 
            }
            if(pacMap[pacman.y + pacman.dirY] && pacMap[pacman.y + pacman.dirY][pacman.x + pacman.dirX] !== 1) { 
                pacman.x += pacman.dirX; pacman.y += pacman.dirY; 
            }
            if(pacman.x < 0) pacman.x = pCols-1; if(pacman.x >= pCols) pacman.x = 0;

            // YEM YEME
            let tile = pacMap[pacman.y][pacman.x];
            if(tile === 0 || tile === 3) {
                if(tile === 0) score += 10;
                if(tile === 3) { score += 50; powerModeTime = 4000; }
                pacMap[pacman.y][pacman.x] = 2; 
                totalPellets--;
                updateScore(score);
                if(totalPellets <= 0) showGameOver(`KAZANDIN! Skor: ${score}`, "#44ff44");
            }

            // HAYALET HAREKETLERİ
            // YAVAŞLATMA MANTIĞI: Her 4 tick'ten 1'ini atla (%75 hız)
            // Eğer güç modu varsa daha da yavaşla
            let ghostSkip = (gameTick % 4 === 0);
            
            ghosts.forEach(g => {
                if(ghostSkip) return; // Bu tur hareket etme
                if(powerModeTime > 0 && Math.random() > 0.6) return; 

                let targetX = pacman.x;
                let targetY = pacman.y;

                if(powerModeTime <= 0 && hasLineOfSight(g, pacman)) {
                } else {
                    if(g.type === 'blue') { targetX += pacman.dirX * 3; targetY += pacman.dirY * 3; } 
                    else if(g.type === 'yellow') {
                         let redG = ghosts.find(gx => gx.type === 'red');
                         if(redG) { targetX = redG.x; targetY = redG.y; }
                    }
                }

                let move = getBestMove(g, targetX, targetY);
                g.x += move.x; g.y += move.y;
                if(g.x < 0) g.x = pCols-1; if(g.x >= pCols) g.x = 0;

                // ÇARPIŞMA
                if(g.x === pacman.x && g.y === pacman.y) {
                    if(powerModeTime > 0) {
                        score += 200; updateScore(score);
                        g.x = g.startX; g.y = g.startY; 
                    } else {
                        pacmanLives--; 
                        if(pacmanLives<=0) showGameOver(); 
                        else resetPacPositions();
                    }
                }
            });

            drawPacman();
        }

        function drawPacman() {
            let s = 30; 
            ctx.fillStyle="black"; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            for(let r=0; r<pacMap.length; r++) for(let c=0; c<pacMap[r].length; c++){
                if(pacMap[r][c]===1) { ctx.strokeStyle="#1919A6"; ctx.strokeRect(c*s+5,r*s+5,s-10,s-10); } 
                else if(pacMap[r][c]===0) { ctx.fillStyle="#ffb8ae"; ctx.fillRect(c*s+13,r*s+13,4,4); } 
                else if(pacMap[r][c]===3) { 
                    ctx.fillStyle = (Math.floor(Date.now()/200)%2===0) ? "#fff" : "#ffcc00";
                    ctx.beginPath(); ctx.arc(c*s+15, r*s+15, 8, 0, Math.PI*2); ctx.fill();
                }
            }
            
            // Pacman
            ctx.fillStyle="yellow"; 
            ctx.beginPath(); 
            let mouthOpen = (Math.floor(Date.now()/100)%2===0) ? 0.2 : 0.05;
            let angle = 0;
            if(pacman.dirX === -1) angle = Math.PI;
            if(pacman.dirY === -1) angle = -Math.PI/2;
            if(pacman.dirY === 1) angle = Math.PI/2;
            
            ctx.arc(pacman.x*s+s/2, pacman.y*s+s/2, s/2-2, angle + mouthOpen, angle + 2*Math.PI - mouthOpen); 
            ctx.lineTo(pacman.x*s+s/2, pacman.y*s+s/2); 
            ctx.fill();

            // Hayaletler
            ghosts.forEach(g => {
                ctx.fillStyle = (powerModeTime > 0) ? "blue" : g.color;
                ctx.beginPath(); ctx.arc(g.x*s+s/2, g.y*s+s/2, s/2-4, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle="white"; 
                ctx.beginPath(); ctx.arc(g.x*s+s/2-4, g.y*s+s/2-2, 3, 0, Math.PI*2); 
                ctx.arc(g.x*s+s/2+4, g.y*s+s/2-2, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle="black";
                ctx.beginPath(); ctx.arc(g.x*s+s/2-4, g.y*s+s/2-2, 1, 0, Math.PI*2); 
                ctx.arc(g.x*s+s/2+4, g.y*s+s/2-2, 1, 0, Math.PI*2); ctx.fill();
            });
        }
    </script>
</body>
</html>
