<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Projesi - Sticky Fix v1.5.2</title>
    
    <!-- AR.js ve A-Frame Kütüphaneleri -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; }
        
        /* UI Katmanı */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none;
            font-family: sans-serif;
        }
        
        #status-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); color: #00ff00;
            padding: 10px 20px; border-radius: 30px; border: 2px solid #00ff00;
            text-align: center; font-weight: bold; font-size: 1rem;
        }

        .debug-info {
            position: absolute; top: 10px; left: 10px;
            color: yellow; background: rgba(0,0,0,0.5); padding: 5px; font-size: 12px;
        }
    </style>

    <script>
        // STICKY (YAPIŞKAN) MANTIK - BASİTLEŞTİRİLMİŞ
        AFRAME.registerComponent('sticky-marker', {
            init: function () {
                const marker = this.el;
                const object = document.getElementById('my-ar-object');
                const statusBox = document.getElementById('status-box');

                // Marker bulunduğunda
                marker.addEventListener('markerFound', function () {
                    statusBox.innerText = "NESNE KİLİTLENDİ! Kamerayı Çevir.";
                    statusBox.style.borderColor = "#ff0055";
                    statusBox.style.color = "#ff0055";
                    
                    // Nesneyi görünür yap
                    object.setAttribute('visible', true);
                });

                // Marker kaybolduğunda (Normalde gizlenir, biz bunu engelliyoruz)
                marker.addEventListener('markerLost', function () {
                    // Nesne zaten görünürse, HİÇBİR ŞEY YAPMA.
                    // AR.js varsayılan olarak gizlemeye çalışır ama biz nesneyi
                    // marker'ın içinden çıkarıp sahneye (world) atadığımız için etkilenmez.
                });
            }
        });

        // Sahne yüklendiğinde nesneyi marker'dan kurtarma operasyonu
        AFRAME.registerComponent('detach-on-load', {
            init: function () {
                const object = this.el;
                const scene = document.querySelector('a-scene');
                
                // Başlangıçta gizle
                object.setAttribute('visible', false);

                const marker = document.querySelector('a-marker');

                marker.addEventListener('markerFound', () => {
                    // Eğer nesne hala marker'ın çocuğuysa, onu evlatlıktan reddet ve sahneye (dünyaya) bağla :)
                    if (object.parentNode === marker) {
                        // 1. Pozisyonu al
                        let worldPos = new THREE.Vector3();
                        let worldQuat = new THREE.Quaternion();
                        let worldScale = new THREE.Vector3();
                        
                        object.object3D.getWorldPosition(worldPos);
                        object.object3D.getWorldQuaternion(worldQuat);
                        object.object3D.getWorldScale(worldScale);

                        // 2. Taşı
                        marker.removeChild(object);
                        scene.appendChild(object);

                        // 3. Pozisyonu geri yükle
                        object.object3D.position.copy(worldPos);
                        object.object3D.quaternion.copy(worldQuat);
                        object.object3D.scale.copy(worldScale);
                        
                        object.setAttribute('visible', true);
                    }
                });
            }
        });
    </script>
</head>

<body>
    <div id="ui-layer">
        <div class="debug-info">v1.5.2 - Sticky Fix</div>
        <div id="status-box">Hiro Marker Göster...</div>
    </div>

    <!-- AR SAHNESİ -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;"
        vr-mode-ui="enabled: false">

        <!-- TEST İÇİN HIRO MARKER (Bunu herkesin telefonu okur) -->
        <a-marker preset="hiro" sticky-marker>
            <!-- 
               detach-on-load: Bu özellik nesneyi marker görünce oradan koparır 
               ve sahneye yapıştırır. Böylece marker gitse de nesne kalır.
            -->
            <a-entity id="my-ar-object" detach-on-load>
                <a-box 
                    position="0 0.5 0" 
                    scale="0.5 0.5 0.5" 
                    material="color: #00ff00; opacity: 0.9;"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 5000">
                </a-box>
                <a-text value="SABITLENDI" position="0 1 0" align="center" scale="0.5 0.5 0.5" color="white"></a-text>
            </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>
</body>
</html>
